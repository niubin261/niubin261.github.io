<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>p4编程 | Bin.Niu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在本篇文章中将讲述p4编程，文章中将结合p4程序的例子介绍p4编程的规则以及流程。p4根据抽象转发模型定义的一门语言，用以表达交换机将如何被配置，数据包将如何被处理  p4编程每一个p4程序都会被分为paser,ingress,egress在parser中可以实现对数据报的解析，在ingress中可以根据定义的table转发数据，在table中需要定义的action完成转发动作，同理在egress">
<meta name="keywords" content="p4交换机">
<meta property="og:type" content="article">
<meta property="og:title" content="p4编程">
<meta property="og:url" content="http://yoursite.com/2017/01/12/交换机/p4的编程/index.html">
<meta property="og:site_name" content="Bin.Niu">
<meta property="og:description" content="在本篇文章中将讲述p4编程，文章中将结合p4程序的例子介绍p4编程的规则以及流程。p4根据抽象转发模型定义的一门语言，用以表达交换机将如何被配置，数据包将如何被处理  p4编程每一个p4程序都会被分为paser,ingress,egress在parser中可以实现对数据报的解析，在ingress中可以根据定义的table转发数据，在table中需要定义的action完成转发动作，同理在egress">
<meta property="og:updated_time" content="2018-04-10T09:25:59.093Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="p4编程">
<meta name="twitter:description" content="在本篇文章中将讲述p4编程，文章中将结合p4程序的例子介绍p4编程的规则以及流程。p4根据抽象转发模型定义的一门语言，用以表达交换机将如何被配置，数据包将如何被处理  p4编程每一个p4程序都会被分为paser,ingress,egress在parser中可以实现对数据报的解析，在ingress中可以根据定义的table转发数据，在table中需要定义的action完成转发动作，同理在egress">
  
    <link rel="alternate" href="/atom.xml" title="Bin.Niu" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Bin.Niu</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-交换机/p4的编程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/12/交换机/p4的编程/" class="article-date">
  <time datetime="2017-01-12T03:00:29.000Z" itemprop="datePublished">2017-01-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      p4编程
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在本篇文章中将讲述p4编程，文章中将结合p4程序的例子介绍p4编程的规则以及流程。<br><strong>p4</strong><br><em>根据抽象转发模型定义的一门语言，用以表达交换机将如何被配置，数据包将如何被处理</em> </p>
<h3 id="p4编程"><a href="#p4编程" class="headerlink" title="p4编程"></a>p4编程</h3><p>每一个p4程序都会被分为paser,ingress,egress<br>在parser中可以实现对数据报的解析，在ingress中可以根据定义的table转发数据，在table中需要定义的action完成转发动作，同理在egress中也可以根据定义的table实现对数据包的转发</p>
<h4 id="一个简单的以太网的直接转发"><a href="#一个简单的以太网的直接转发" class="headerlink" title="一个简单的以太网的直接转发"></a>一个简单的以太网的直接转发</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">header_type eth_hdr &#123;</span><br><span class="line">    fields &#123;</span><br><span class="line">        dst : 48;</span><br><span class="line">        src : 48;</span><br><span class="line">        etype : 16;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//header</span><br><span class="line">header eth_hdr eth;//定义以太帧的实例</span><br><span class="line">parser start &#123;</span><br><span class="line">    return eth_parser;</span><br><span class="line">&#125;</span><br><span class="line">parser eth_parser &#123;</span><br><span class="line">    extract(eth);//提取该以太帧</span><br><span class="line">    return ingress;</span><br><span class="line">&#125;</span><br><span class="line">//action drop_act() &#123;</span><br><span class="line"> //   drop();</span><br><span class="line">//&#125;</span><br><span class="line">action forward_act(espec) &#123;//espec为rule的参数</span><br><span class="line">    modify_field(standard_metadata.egress_spec,espec);//从端口espec转发</span><br><span class="line">&#125;</span><br><span class="line">table fwd_table &#123;</span><br><span class="line">    reads &#123;</span><br><span class="line">        standard_metadata.ingress_port : exact;//精确匹配ingress</span><br><span class="line">    &#125;</span><br><span class="line">    actions &#123;</span><br><span class="line">  //      drop_act;</span><br><span class="line">        forward_act;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">control ingress &#123;</span><br><span class="line">    apply(fwd_table);</span><br><span class="line">&#125;</span><br><span class="line">control egress&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="精确匹配目的ip地址的转发"><a href="#精确匹配目的ip地址的转发" class="headerlink" title="精确匹配目的ip地址的转发"></a>精确匹配目的ip地址的转发</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">header_type eth_hdr &#123;</span><br><span class="line">    fields &#123;</span><br><span class="line">        dst : 48;</span><br><span class="line">        src : 48;</span><br><span class="line">        etype : 16;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//header</span><br><span class="line">header_type ipv4_hdr &#123;</span><br><span class="line">    fields &#123;</span><br><span class="line">        version : 4;</span><br><span class="line">        ihl : 4;</span><br><span class="line">        diffserv : 8;</span><br><span class="line">        totalLen : 16;</span><br><span class="line">        identification : 16;</span><br><span class="line">        flag : 3;</span><br><span class="line">        fragOffset : 13;</span><br><span class="line">        ttl : 8;</span><br><span class="line">        protocol : 8;</span><br><span class="line">        hdrChecksum : 16;</span><br><span class="line">        srcAddr : 32;</span><br><span class="line">        dstAddr : 32;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">header ipv4_hdr ipv4;</span><br><span class="line">header eth_hdr eth;</span><br><span class="line">parser start &#123;</span><br><span class="line">    return eth_parser;</span><br><span class="line">&#125;</span><br><span class="line">parser eth_parser &#123;</span><br><span class="line">    extract(eth);</span><br><span class="line"></span><br><span class="line">    return select(latest.etype) &#123;</span><br><span class="line">        0x0800 : ipv4_parser;</span><br><span class="line">        default : ingress;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">parser ipv4_parser &#123;</span><br><span class="line">    extract(ipv4);</span><br><span class="line">    return ingress;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">//action drop_act() &#123;</span><br><span class="line"> //   drop();</span><br><span class="line">//&#125;</span><br><span class="line">action forward_act(espec) &#123;</span><br><span class="line">    modify_field(standard_metadata.egress_spec,espec);</span><br><span class="line">&#125;</span><br><span class="line">table fwd_table &#123;</span><br><span class="line">    reads &#123;</span><br><span class="line">        ipv4.dstAddr : exact;//根据ip目的地址精确匹配转发</span><br><span class="line">    &#125;</span><br><span class="line">    actions &#123;</span><br><span class="line">  //      drop_act;</span><br><span class="line">        forward_act;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">control ingress &#123;</span><br><span class="line">    apply(fwd_table);</span><br><span class="line">&#125;</span><br><span class="line">control egress&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>####添加vlan的实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h4 id="copytocpu的实现"><a href="#copytocpu的实现" class="headerlink" title="copytocpu的实现"></a>copytocpu的实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">header_type ethernet_t &#123;</span><br><span class="line">    fields&#123;</span><br><span class="line">        dstAddr : 48;</span><br><span class="line">        srcAddr : 48;</span><br><span class="line">        ethertype : 16;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">header_type vlan_t &#123;</span><br><span class="line">    fields&#123;</span><br><span class="line">        pcp :3;</span><br><span class="line">        cfi :1;</span><br><span class="line">        vid :12;</span><br><span class="line">        ethertype :16;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">header ethernet_t ethernet;</span><br><span class="line">header vlan_t vlan;</span><br><span class="line">parser start &#123;</span><br><span class="line">    return parser_ethernet;</span><br><span class="line">&#125;</span><br><span class="line">parser parser_ethernet &#123;</span><br><span class="line">    extract(ethernet);</span><br><span class="line">    return select(latest.ethertype)&#123;</span><br><span class="line">        0x8100 : parser_vlan;</span><br><span class="line">        default : ingress;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">parser parser_vlan &#123;</span><br><span class="line">    extract(vlan);</span><br><span class="line">    return ingress;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">action add_vlan()&#123;</span><br><span class="line">    modify_field(ethernet.ethertype,0x8100);</span><br><span class="line">    add_header(vlan);</span><br><span class="line">    modify_field(vlan.pcp,0);</span><br><span class="line">    modify_field(vlan.cfi,0);</span><br><span class="line">    modify_field(vlan.vid,0);</span><br><span class="line">    modify_field(vlan.ethertype,0x0800);</span><br><span class="line">&#125;</span><br><span class="line">table add_vlan_tbl&#123;</span><br><span class="line">       // reads &#123;</span><br><span class="line">          //  ethernet.ethertype:exact;</span><br><span class="line">       // &#125;</span><br><span class="line"></span><br><span class="line">        actions &#123;</span><br><span class="line">            add_vlan;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">action do_fwd(port)&#123;</span><br><span class="line">    modify_field(standard_metadata.egress_spec,port);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">table do_fwd_tbl&#123;</span><br><span class="line">    //reads &#123;</span><br><span class="line">      //  standard_metadata.ingress:exact;</span><br><span class="line">    //&#125;</span><br><span class="line">    actions &#123;</span><br><span class="line">        do_fwd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">control ingress&#123;</span><br><span class="line"></span><br><span class="line">    //if(ethernet.ethertype == 0x0800) &#123;</span><br><span class="line">       // apply(add_vlan_tbl);</span><br><span class="line">   // &#125; </span><br><span class="line"></span><br><span class="line">    //apply(add_vlan_tbl);</span><br><span class="line">    </span><br><span class="line">    apply(do_fwd_tbl);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">control egress &#123;</span><br><span class="line">   //apply(add_vlan_tbl);如果只是单纯的这样起不到作用目前不知道为什么</span><br><span class="line">       if(not valid(vlan))&#123;</span><br><span class="line">        apply(add_vlan_tbl);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>valid关键字可以判断解析的头是否存在，如果没有解析到头部表示为0，如果解析到表示为0  </p>
<h4 id="bmv2的使用教程"><a href="#bmv2的使用教程" class="headerlink" title="bmv2的使用教程"></a>bmv2的使用教程</h4><p><strong>安装</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/p4lang/behavioral-model.git</span><br><span class="line"><span class="built_in">cd</span> behavioral-model</span><br><span class="line">./install_deps.sh</span><br><span class="line"></span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install  <span class="comment"># if you need to install bmv2</span></span><br><span class="line">sudo ldconfig</span><br><span class="line">make check</span><br><span class="line"><span class="comment"># Download p4c-bm</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/p4lang/p4c-bm.git</span><br><span class="line"><span class="built_in">cd</span> p4c-bm</span><br><span class="line"><span class="comment"># Install the requirements</span></span><br><span class="line">sudo pip install -r requirements.txt</span><br><span class="line"><span class="comment"># Install p4c-bm</span></span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure></p>
<p><strong>运行p4程序</strong><br>p4c-bmv2 –json &lt;输出的JSON文件名&gt; &lt;输入的P4文件名&gt;<br><strong>使用simple_switch</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> behavioral-model/targets/simple_switch</span><br><span class="line">sudo ./simple_switch -i 0@&lt;iface0&gt; -i 1@&lt;iface1&gt; &lt;path to JSON file&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>将p4mininet的Python包导入</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lib/python2.7/dist-packges</span><br><span class="line">touch p4.miminet.pth</span><br><span class="line">//在文件中将/home/niubin/bmv2/mininet键入</span><br><span class="line">//之后修改一下env.sh文件的内容将文件目录改为自己的</span><br></pre></td></tr></table></figure></p>
<h4 id="p4的语法分析"><a href="#p4的语法分析" class="headerlink" title="p4的语法分析"></a>p4的语法分析</h4><p><strong>header</strong><br>parser包含了两个部分，第一个部分是header，第二部分为parser  header代表了哪些格式的头可以使会用比如常用的ethernet,ipv4,tcp,vlan等<br>比如最简单的以太帧头为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">header_type ethernet_t &#123;</span><br><span class="line">    fields &#123;</span><br><span class="line">        dst_addr : 48;</span><br><span class="line">        src_addr : 48;</span><br><span class="line">        ether_type : 16;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>header_type类似于c中的class，需要自己定义实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header ethernet eth;</span><br></pre></td></tr></table></figure></p>
<p><strong>parser</strong><br>一个parser先从start开始<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parser start &#123;</span><br><span class="line">    return eth_parser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>转入下一个parser中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parser eth_parser &#123;</span><br><span class="line">    extract(eth);</span><br><span class="line">    return select(eth.ether_type) &#123;//select类似于switch</span><br><span class="line">        0x0800 : ipv4_parser;</span><br><span class="line">        default : ingress;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>field_list</strong><br>通常可以使用这个实现hash值的计算以及校验和的计算<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">field_lsit ethchecksum_fields &#123;</span><br><span class="line">    eth.dst_addr;</span><br><span class="line">    eth.src.addr;</span><br><span class="line">    eth.eth_type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>field_list_calculation</strong><br>通常使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">field_list_calculation flowlet_ecmp_hash &#123;</span><br><span class="line">    input &#123;</span><br><span class="line">        flowlet_l3_hash_fields;</span><br><span class="line">    &#125;</span><br><span class="line">    algorithm : crc16;</span><br><span class="line">    output_width : ECMP_BIT_WIDTH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输入为fields输出位flowlet_ecmp_hash<br><strong>register</strong><br>针对有状态的变量存储在内存中<br>比如在检测heavy_hitter的时候可以存储一个流的数量，一个流可以使用五元组的hash值标记<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">register count1 &#123;</span><br><span class="line">    width :16;</span><br><span class="line">    instance_count :16;</span><br><span class="line">&#125;</span><br><span class="line">register_reader();//</span><br><span class="line">register_writer();//</span><br><span class="line">register_read(custom_metadata.count1, count1, custom_metadata.hash1);</span><br><span class="line">register_write(count1,costom_metadata.hash1,custmo_metadata.count1);//用hash值标识count1</span><br></pre></td></tr></table></figure></p>
<p><strong>action</strong><br>action处理前述的parser得到的header<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">action fwd(parm,parm2,....) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最常用的action<br>下面以表格的形式:  </p>
<table>
<thead>
<tr>
<th>Table</th>
<th style="text-align:center">Col1</th>
</tr>
</thead>
<tbody>
<tr>
<td>modify_filed(dst,value)</td>
<td style="text-align:center">更改某一个特定的值，其中 dst 可以是 header_inst.field 或是 register</td>
</tr>
<tr>
<td>add_to_filed(dst,value)</td>
<td style="text-align:center">將 value 加到 dst 中，其中 dst 可以是 header_inst.field 或是 register，比如ttl减一dst=ipv4.ttl,value=-1</td>
</tr>
<tr>
<td>add_header(header_instane)</td>
<td style="text-align:center">加入一個 Header。Header 初值都是零</td>
</tr>
<tr>
<td>drop()</td>
<td style="text-align:center">egress直接丢弃</td>
</tr>
<tr>
<td>modify_field_with_hash_based_offset(dest, field_list_calc, base, size)</td>
<td style="text-align:center">有filed_list_calc计算出来的hash存储到dst中去，base产生之后new_hash = base + hash_val % size</td>
</tr>
<tr>
<td>meter(meter_ref, index, field)</td>
<td style="text-align:center">更新meter</td>
</tr>
</tbody>
</table>
<p><strong>table</strong>  </p>
<p>类似于openflow  ，<br>其定义为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">table table_name &#123;</span><br><span class="line">    reads &#123;</span><br><span class="line">        field1 : match_type1 ;</span><br><span class="line">        field2 : match_type1 ;</span><br><span class="line">        // ....</span><br><span class="line">    &#125;</span><br><span class="line">    actions &#123;</span><br><span class="line">        action1;</span><br><span class="line">        action2;</span><br><span class="line">        // .....</span><br><span class="line">    &#125;</span><br><span class="line">    min_size : value;</span><br><span class="line">    max_size : value;</span><br><span class="line">    size : value;</span><br><span class="line">    support_timeout : true or false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>命令行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add_entry table_name match_fields action_name action_parameters</span><br></pre></td></tr></table></figure></p>
<p><strong>metadata</strong><br>//TODO<br>像定义header一样定义使用，会在actions中以及control中被使用到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">header_type my_metadata_t &#123;</span><br><span class="line">    fields &#123;</span><br><span class="line">        field1: 8; // size, bits</span><br><span class="line">        field2: 4;</span><br><span class="line">        field3: 2;</span><br><span class="line">        /* ... */</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header my_metadata_t my_metadata;</span><br></pre></td></tr></table></figure></p>
<p><strong>standard meterdata</strong><br><em>每一个包进来的时候会被封装产生如<code>ingress port</code>或者packet length</em><br>使用方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">standard_metadata.filed</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>Table</th>
<th style="text-align:center">Col1</th>
</tr>
</thead>
<tbody>
<tr>
<td>ingress_port</td>
<td style="text-align:center">进来的port</td>
</tr>
<tr>
<td>packet_length</td>
<td style="text-align:center">包长度</td>
</tr>
<tr>
<td>egress_spec</td>
<td style="text-align:center">ingress中设定包出去的口</td>
</tr>
<tr>
<td>egress_instance</td>
<td style="text-align:center">实体口</td>
</tr>
<tr>
<td>instance_type</td>
<td style="text-align:center">表示一般的或者复制的0表示一般的1表示复制的</td>
</tr>
</tbody>
</table>
<p><strong>register</strong><br>定义方式如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">register register_name &#123;</span><br><span class="line">    width : const_value;</span><br><span class="line">    layout : header_type_name;</span><br><span class="line">    [direct : table_name;]</span><br><span class="line">    [static : table_name;]</span><br><span class="line">    [instance_count : const_value;]</span><br><span class="line">    [attribute_list;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其使用方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">register_name.field</span><br></pre></td></tr></table></figure></p>
<p><strong>meter</strong><br>//TODO<br>meter meter_name {<br>    type : bytes|packets;//以包为单位以byte为单位<br>    result : field_ref;<br>    instance_count = 4;<br>}<br>其作用主要用来限速的<br><strong>bmv2中p4代码中流表的匹配规则</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">action set_nhop(nhop_ipv4, port) &#123;</span><br><span class="line">    modify_field(meta.nhop_ipv4, nhop_ipv4);</span><br><span class="line">    modify_field(standard_metadata.egress_spec, port);</span><br><span class="line">    add_to_field(ipv4.ttl, -1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table ipv4_lpm &#123;</span><br><span class="line">    reads &#123;</span><br><span class="line">        meta.ipv4_da : lpm;</span><br><span class="line">    &#125;</span><br><span class="line">    actions &#123;</span><br><span class="line">        set_nhop;</span><br><span class="line">        _drop;</span><br><span class="line">    &#125;</span><br><span class="line">    size: 1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其添加的entry:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">table_add ipv4_lpm set_nhop 10.0.0.10/32 =&gt; 10.0.0.10 1</span><br><span class="line">table_add ipv4_lpm set_nhop 192.168.0.10/32 =&gt; 192.168.0.10 2</span><br></pre></td></tr></table></figure></p>
<p>说明：<br><code>=&gt;</code>前面是match的匹配参数，后面是action匹配参数<br>比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">table nat      &#123;</span><br><span class="line">    reads &#123;</span><br><span class="line">        meta.is_ext_if : exact;</span><br><span class="line">        ipv4 : valid;</span><br><span class="line">        tcp : valid;</span><br><span class="line">        ipv4.srcAddr : ternary;//field的匹配方式有五种分别为:</span><br><span class="line">        //</span><br><span class="line">        ipv4.dstAddr : ternary;</span><br><span class="line">        tcp.srcPort : ternary;</span><br><span class="line">        tcp.dstPort : ternary;</span><br><span class="line">    &#125;</span><br><span class="line">    actions &#123;</span><br><span class="line">        _drop;</span><br><span class="line">        nat_miss_int_to_ext;</span><br><span class="line">        nat_miss_ext_to_int;</span><br><span class="line">        nat_hit_int_to_ext;</span><br><span class="line">        nat_hit_ext_to_int;</span><br><span class="line">        nat_no_nat;  // for debugging</span><br><span class="line">    &#125;</span><br><span class="line">    size : 128;</span><br><span class="line">    support_timeout = ture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>添加如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">table_add nat nat_miss_ext_to_int 1 1 1 0.0.0.0&amp;&amp;&amp;0.0.0.0 0.0.0.0&amp;&amp;&amp;0.0.0.0 0&amp;&amp;&amp;0 0&amp;&amp;&amp;0 =&gt; 99//99代表的是优先级别</span><br><span class="line">table_add nat nat_miss_int_to_ext 0 1 1 0.0.0.0&amp;&amp;&amp;0.0.0.0 0.0.0.0&amp;&amp;&amp;0.0.0.0 0&amp;&amp;&amp;0 0&amp;&amp;&amp;0 =&gt; 99//支持support_timeout = ture;</span><br></pre></td></tr></table></figure></p>
<p>//TODOmiss为什么如此配置??<br>通过脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_add nat nat_hit_int_to_ext 0 1 1 %s&amp;&amp;&amp;255.255.255.255 0.0.0.0&amp;&amp;&amp;0.0.0.0 %d&amp;&amp;&amp;0xffff 0&amp;&amp;&amp;0 =&gt; %s %d 1</span><br></pre></td></tr></table></figure></p>
<p><strong>智能网卡的命令</strong>，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">添加流表</span><br><span class="line">sudo python sdk6_rte_cli.py -r 192.168.109.204 -p 20206 tables -t fwd_table  -r fwd1 -m &apos;&#123; &quot;ipv4.dstAddr&quot; : &#123;  &quot;value&quot; : &quot;10.0.0.0/24&quot; &#125; &#125;&apos; -a &apos;&#123;  &quot;type&quot; : &quot;forward_act&quot;,  &quot;data&quot; : &#123; &quot;port&quot; : &#123; &quot;value&quot; : &quot;v0.2&quot; &#125; &#125; &#125;&apos; add</span><br><span class="line">删除流表</span><br><span class="line">sudo python sdk6_rte_cli.py -r 192.168.109.204 -p 20206 tables -t fwd_table  -r fwd1 -m &apos;&#123; &quot;ipv4.dstAddr&quot; : &#123;  &quot;value&quot; : &quot;10.0.0.0/24&quot; &#125; &#125;&apos; -a &apos;&#123;  &quot;type&quot; : &quot;forward_act&quot;,  &quot;data&quot; : &#123; &quot;port&quot; : &#123; &quot;value&quot; : &quot;v0.2&quot; &#125; &#125; &#125;&apos; delete</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/12/交换机/p4的编程/" data-id="cjd35unmr000hz0j3i9haf57g" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/p4交换机/">p4交换机</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/01/12/统计学习/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          统计学习
        
      </div>
    </a>
  
  
    <a href="/2017/01/04/算法/回溯法/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">回溯算法</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/p4交换机/">p4交换机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/交换机的使用/">交换机的使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/博客介绍/">博客介绍</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/智能网卡/">智能网卡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/统计学习/">统计学习</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/p4交换机/" style="font-size: 10px;">p4交换机</a> <a href="/tags/交换机的使用/" style="font-size: 20px;">交换机的使用</a> <a href="/tags/博客介绍/" style="font-size: 10px;">博客介绍</a> <a href="/tags/智能网卡/" style="font-size: 10px;">智能网卡</a> <a href="/tags/算法/" style="font-size: 10px;">算法</a> <a href="/tags/统计学习/" style="font-size: 10px;">统计学习</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/02/05/6.824/mapreduce入门/">(no title)</a>
          </li>
        
          <li>
            <a href="/2017/12/29/thrift的入门/">rpc框架thrift入门</a>
          </li>
        
          <li>
            <a href="/2017/12/25/交换机/OvS的使用/">OvS的使用</a>
          </li>
        
          <li>
            <a href="/2017/12/16/发包工具的使用/">发包工具的使用</a>
          </li>
        
          <li>
            <a href="/2017/12/13/hello-world-bin-niu/">hello world bin.niu</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 BinNiu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>